<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervacija</title>
    <link rel="stylesheet" type="text/css" href="styles/rezervacija.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="step-info" id="step-info">Step 1/8</div>
            <button class="next-btn" id="next-btn" onclick="nextStep()">Next</button>
        </div>

        <div class="steps">
            <!-- Step 1 -->
            <div class="step active" id="step1">
                <h1>Veličina grupe</h1>
                <div class="options">
                    <button class="option-btn" id="parovi" onclick="selectOption('Za parove')">Za parove</button>
                    <button class="option-btn" id="grupa" onclick="selectOption('Grupa 3-5')">Grupa 3-5</button>
                    <button class="option-btn" id="teambuilding" onclick="selectOption('Teambuilding')">Teambuilding</button>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="step" id="step2">
                <h1>Duljina ture</h1>
                <div class="options">
                    <button class="option-btn" id="kratka" onclick="selectOption('Kratka')">Kratka</button>
                    <button class="option-btn" id="srednja" onclick="selectOption('Srednja')">Srednja</button>
                    <button class="option-btn" id="duga" onclick="selectOption('Duga')">Duga</button>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="step" id="step3">
                <div class="right">
                    <h1>Ture</h1>
                    <div id="tura-buttons">
                        <!-- Buttons for tours will be dynamically generated here -->
                    </div>
                </div>
                <div class="left">
                    <h1>Informacije o turi</h1>
                    <div class="tura-description" id="tura-description">
                        <!-- Selected tour information will be displayed here -->
                    </div>
                </div>
            </div>

          <!-- Step 4 -->
            <div class="step" id="step4">
                <h1>Odaberite datum</h1>
                <input type="date" id="reservation-date" class="date-input" onchange="selectDate()">
                <div id="selected-date" class="selected-date"></div>

                <!-- Time Selection (initially hidden) -->
                <div id="time-selection" class="time-selection" style="display: none;">
                    <h2>Odaberite vrijeme</h2>
                    <div id="time-buttons-container"></div>
                </div>

                <!-- Display selected time -->
                <div id="selected-time" class="selected-time"></div>
            </div>




            <!-- Step 5 -->
            <div class="step" id="step5">
                <div class="right">
                    <h1>Vodici</h1>
                    <div id="vodic-buttons">
                        <!-- Buttons for guides will be dynamically generated here -->
                    </div>
                </div>
                <div class="left">
                    <h1>Informacije o vodicu</h1>
                    <div class="vodic-description" id="vodic-description">
                        <!-- Selected guide information will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Step 6 -->
            <div class="step" id="step6">
                <h1>Odaberite ljubimca</h1>
                <div class="options">
                    <button class="option-btn" id="pas" onclick="selectOption('Pas')">Pas</button>
                    <button class="option-btn" id="svinja" onclick="selectOption('Svinja')">Svinja</button>
                </div>
            </div>

            <!-- Step 7 -->
            <div class="step" id="step7">
                <div class="right">
                    <h1>Životinje</h1>
                    <div id="zivotinja-buttons">
                        <!-- Buttons for animals will be dynamically generated here -->
                    </div>
                </div>
                <div class="left">
                    <h1>Informacije o životinji</h1>
                    <div class="zivotinja-description" id="zivotinja-description">
                        <!-- Selected animal information will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Step 8 -->
            <div class="step" id="step8">
                <h1>Pregled rezervacije</h1>
                <div id="summary" class="summary">
                    <p><strong>Veličina grupe:</strong> <span id="summary-group-size"></span></p>
                    <p><strong>Tura:</strong> <span id="summary-tour"></span></p>
                    <p><strong>Datum rezervacije:</strong> <span id="summary-date"></span></p>
                    <p><strong>Vrijeme:</strong> <span id="summary-time"></span></p>
                    <p><strong>Vodic:</strong> <span id="summary-guide"></span></p>
                    <p><strong>Životinja:</strong> <span id="summary-animal"></span></p>
                    <p><strong>Cijena:</strong> <span id="summary-price"></span></p>
                </div>
                <button class="save-btn" id="save-btn" onclick="saveReservation()">Save Reservation</button>
            </div>

        </div>
    </div>

    <script type="module">
        import service from './scripts/service.js'; 

        window.currentStep = 1;
        const totalSteps = 8;
        window.selectedOption = '';
        window.groupSize = '';
        window.tourLength = '';
        window.tourId = '';
        window.selectedDate = ''; // Initialize variable to store selected date
        window.selectedGuide = ''; // Initialize variable to store selected guide
        window.selectedPet = ''; // Initialize variable to store selected pet
        window.reservation;
        window.routeTime;
        window.selectedTime;

        function showButtons(step) {
            if (step === 1) {
                setTimeout(() => document.getElementById('parovi').classList.add('visible'), 1000);
                setTimeout(() => document.getElementById('grupa').classList.add('visible'), 2000);
                setTimeout(() => document.getElementById('teambuilding').classList.add('visible'), 3000);
            } else if (step === 2) {
                setTimeout(() => document.getElementById('kratka').classList.add('visible'), 1000);
                setTimeout(() => document.getElementById('srednja').classList.add('visible'), 2000);
                setTimeout(() => document.getElementById('duga').classList.add('visible'), 3000);
            } else if (step === 3) {
                fetchTours(); // Call function to fetch tours on step 3
            } else if (step === 4) {
                // Any additional logic for step 4 if needed
            } else if (step === 5) {
                fetchVodici(); // Fetch guides on step 5
            } else if (step === 6) {
                // Show buttons for selecting pets in Step 6
                setTimeout(() => document.getElementById('pas').classList.add('visible'), 1000);
                setTimeout(() => document.getElementById('svinja').classList.add('visible'), 2000);
            }else if (step === 7) {
                fetchZivotinje(); // Fetch animals on step 7
            }
        }

        function selectOption(option) {
            document.querySelectorAll('.option-btn').forEach(function(button) {
                button.classList.remove('selected');
            });
            document.querySelector(`.option-btn[onclick="selectOption('${option}')"]`).classList.add('selected');

            window.selectedOption = option;
            document.getElementById('next-btn').style.display = 'block'; // Show Next button
        }

        function nextStep() {
            if (window.selectedOption || window.currentStep === 4 || window.currentStep === 5 || window.currentStep === 6) { // Allow moving to step 4, 5, and 6 without selection
                document.getElementById('next-btn').style.display = 'none';

                
                switch (window.currentStep) {
                    case 1:
                        window.groupSize = window.selectedOption;
                        console.log("1. Untar switcha: " + window.groupSize);
                        break;
                    case 2:
                        window.tourLength = window.selectedOption;
                        console.log("2. Untar switcha: " + window.tourLength);
                        break;
                    case 3:
                        window.tourId = window.selectedOption;
                        console.log("3. Untar switcha: " + window.tourId);
                        break;
                    case 4:
                        window.selectedDate = document.getElementById('reservation-date').value;
                        window.routeTime = window.selectedTime;
                        console.log("4. Untar switcha: " + window.selectedDate + "\nVrijeme: " + window.routeTime);
                        break;
                    case 5:
                        window.selectedGuide = window.selectedOption;
                        console.log("5. Untar switcha: " + window.selectedGuide.imePrezime);
                        break;
                    case 6:
                        window.selectedPet = window.selectedOption;
                        console.log("6. Untar switcha: " + window.selectedPet);
                        break;
                    case 7:
                        window.selectedAnimal = window.selectedOption;
                        console.log("7. Untar switcha: " + window.selectedAnimal);
                        buildReservation();
                        break;
                    default:
                        console.log("Error");
                }

                //console.log(window.selectedOption);
                window.selectedOption = '';

                // Hide all option buttons
                document.querySelectorAll('.option-btn').forEach(function(button) {
                    button.classList.remove('visible');
                });

                const currentStepElement = document.getElementById(`step${window.currentStep}`);
                currentStepElement.classList.remove('active');

                window.currentStep++;
                const nextStepElement = document.getElementById(`step${window.currentStep}`);
                nextStepElement.classList.add('active');

                document.getElementById('step-info').innerText = `Step ${window.currentStep}/8`;

                // Show buttons for the next step
                showButtons(window.currentStep);
            }
        }

        async function saveReservation() {
            await service.addZakazaneTure(window.reservation);
            alert("Reservation saved successfully!"); // Placeholder alert for now
        }

        async function buildReservation(){
            
            let cijena = 0;

            switch(window.groupSize){
                case "Za parove":
                    cijena += 20;
                    break;
                case "Grupa 3-5":
                    cijena += 50;
                    break;
                case "Teambuilding":
                    cijena += 100;
                    break;
                default:
                    console.log("Error");
            }

            switch(window.tourLength){
                case "Kratka":
                    cijena += 100;
                    break;
                case "Srednja":
                    cijena += 150;
                    break;
                case "Duga":
                    cijena += 200;
                    break;
                default:
                    console.log("Error");
            }
            
            const user = await service.getKorisnikByUsername(localStorage.getItem('username'));
            
            window.reservation = {
                tura: {id: window.tourId.id},
                korisnik: {id: user.id},
                vodic: {id: window.selectedGuide.id},
                zivotinja: {id: window.selectedAnimal.id},
                datum: window.selectedDate,
                vrijeme_ture: window.routeTime,
                velicina_grupe: window.groupSize,
                cijena_ture: cijena
            }

            document.getElementById('summary-group-size').innerText = window.groupSize;
            document.getElementById('summary-tour').innerText = window.tourId ? window.tourId.ime : ''; // Ensure you get the name of the selected tour
            document.getElementById('summary-date').innerText = window.selectedDate;
            document.getElementById('summary-time').innerText = window.reservation.vrijeme_ture;
            document.getElementById('summary-guide').innerText = window.selectedGuide ? window.selectedGuide.imePrezime : ''
            document.getElementById('summary-animal').innerText = window.selectedAnimal ? window.selectedAnimal.ime : '';
            document.getElementById('summary-price').innerText = window.reservation.cijena_ture;
        }

        async function fetchTours() {
            // Fetch tours based on tourLength and populate buttons
            const tours = await service.getTuraAll(); // Fetch all tours
            const filteredTours = tours.filter(tour => tour.duljina.duljina === window.tourLength); // Filter by selected length

            const turaButtonsDiv = document.getElementById('tura-buttons');
            turaButtonsDiv.innerHTML = ''; // Clear previous buttons

            filteredTours.forEach(tour => {
                const button = document.createElement('button');
                button.className = 'tura-btn';
                button.innerText = tour.ime; // Set button text to tour name
                button.onclick = () => selectTour(tour); // Attach click handler
                turaButtonsDiv.appendChild(button); // Append button to the div
            });

            // Check if buttons were added
            if (filteredTours.length === 0) {
                turaButtonsDiv.innerHTML = '<p>No tours available for the selected length.</p>';
            }
        }

        function selectTour(tour) {
            window.selectedOption = tour;
            const descriptionDiv = document.getElementById('tura-description');
            descriptionDiv.innerHTML = `<strong>${tour.ime}</strong><p>${tour.opis}</p>`;
            document.getElementById('next-btn').style.display = 'block'; // Show next button
        }

        async function fetchVodici() {
            // Fetch guides and populate buttons
            const vodici = await service.getVodicAll(); // Fetch all guides

            const vodicButtonsDiv = document.getElementById('vodic-buttons');
            vodicButtonsDiv.innerHTML = ''; // Clear previous buttons

            vodici.forEach(vodic => {
                const button = document.createElement('button');
                button.className = 'vodic-btn';
                button.innerText = vodic.imePrezime; // Set button text to guide name
                button.onclick = () => selectVodic(vodic); // Attach click handler
                vodicButtonsDiv.appendChild(button); // Append button to the div
            });

            // Check if buttons were added
            if (vodici.length === 0) {
                vodicButtonsDiv.innerHTML = '<p>No guides available.</p>';
            }
        }

        function selectVodic(vodic) {
            window.selectedOption = vodic;
            const descriptionDiv = document.getElementById('vodic-description');
            descriptionDiv.innerHTML = `<strong>${vodic.imePrezime}</strong><strong>${vodic.brojTura}</strong><p>${vodic.opis}</p>`;
            document.getElementById('next-btn').style.display = 'block'; // Show next button
        }

        async function fetchZivotinje() {
            // Fetch animals based on the selected pet type and populate buttons
            const zivotinje = await service.getZivotinjaAll(); // Fetch all animals
            const filteredZivotinje = zivotinje.filter(zivotinja => zivotinja.vrsta === window.selectedPet); // Filter by selected type

            const zivotinjaButtonsDiv = document.getElementById('zivotinja-buttons');
            zivotinjaButtonsDiv.innerHTML = ''; // Clear previous buttons

            filteredZivotinje.forEach(zivotinja => {
                const button = document.createElement('button');
                button.className = 'zivotinja-btn';
                button.innerText = zivotinja.ime; // Set button text to animal name
                button.onclick = () => selectZivotinja(zivotinja); // Attach click handler
                zivotinjaButtonsDiv.appendChild(button); // Append button to the div
            });

            // Check if buttons were added
            if (filteredZivotinje.length === 0) {
                zivotinjaButtonsDiv.innerHTML = '<p>No animals available for the selected type.</p>';
            }
        }

        function selectZivotinja(zivotinja) {
            window.selectedOption = zivotinja;
            const descriptionDiv = document.getElementById('zivotinja-description');
            descriptionDiv.innerHTML = `<strong>${zivotinja.ime}</strong><p>${zivotinja.opis}</p>`;
            document.getElementById('next-btn').style.display = 'block'; // Show next button
        }

        function selectDate() {
            const dateInput = document.getElementById('reservation-date');
            const selectedDateDiv = document.getElementById('selected-date');
            
            const date = new Date(dateInput.value);
            if (!isNaN(date)) {
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                selectedDateDiv.innerText = `Odabrani datum: ${date.toLocaleDateString('en-US', options)}`;
                 // Show next button
                 document.getElementById("time-selection").style.display = "block";
                 generateTimeButtons(dateInput.value);
            } else {
                selectedDateDiv.innerText = '';
            }
        }

        async function generateTimeButtons(selectedDate) {
            const timeContainer = document.getElementById("time-buttons-container");
            timeContainer.innerHTML = ""; // Clear previous buttons

            let startHour = 9;
            let endHour = 15;
            let interval;

            // Set interval based on tour length
            if (window.tourLength === "Kratka") {
                interval = 1;
            } else if (window.tourLength === "Srednja") {
                interval = 2;
            } else if (window.tourLength === "Duga") {
                interval = 3;
            } else {
                console.error("Invalid tour length");
                return;
            }

            // Get reserved times for the selected date and tour type
            const reservedTimes = await getReservedTimes(selectedDate);
            console.log("Reserved times:", reservedTimes); // Logging for debugging

            // Generate buttons based on the interval
            for (let hour = startHour; hour <= endHour; hour += interval) {
                const timeString = `${hour}:00`;
                const button = document.createElement("button");
                button.type = "button";
                button.className = "time-button";
                button.innerText = timeString;

                // Disable button if time is reserved
                if (reservedTimes.includes(hour)) { // Check if the timeString is in reservedTimes
                    button.disabled = true;
                    button.style.backgroundColor = "gray"; // Gray out the button
                    button.style.color = "white"; // Change text color for better visibility
                } else {
                    button.onclick = () => selectTime(timeString);
                }

                timeContainer.appendChild(button);
            }
        }

        async function getReservedTimes(selectedDate) {
            const zakazane_ture = await service.getZakazaneTureAll(); // Fetch from your database
            console.log("Fetched reserved tours:", zakazane_ture); // Debugging

            const reservedTimes = [];

            // Filter the zakazane_ture to get reserved times for the selected date and tour type
            zakazane_ture.forEach(zt => {
                // Check if the tour ID and date match
                if (zt.tura.id === window.tourId.id && zt.datum === selectedDate) {
                    reservedTimes.push(zt.vrijeme_ture); // Extract reserved time
                    console.log(`Reserved time found: ${zt.vrijeme_ture}`); // Debugging
                }
            });

            // Log the reserved times to verify structure
            console.log("Filtered reserved times:", reservedTimes);
            
            return reservedTimes; // Ensure this returns an array
        }

        function selectTime(time) {
            // Update the displayed selected time
            document.getElementById("selected-time").innerText = "Odabrano vrijeme: " + time;
            window.selectedTime = time.split(':')[0];
            document.getElementById('next-btn').style.display = 'block'; // Show next button
        }




        document.addEventListener('DOMContentLoaded', function() {
            showButtons(1);
        });

        // Make functions available globally
        window.selectOption = selectOption;
        window.nextStep = nextStep;
        window.selectDate = selectDate;
        window.selectTime = selectTime;
        window.saveReservation = saveReservation;

    </script>

</body>
</html>
